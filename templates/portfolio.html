<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fountain AI — My Portfolio</title>
  <link rel="icon" type="image/png" href="/static/company_logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#0b1020;color:#e9ecf1;font:16px/1.5 system-ui,Segoe UI,Roboto,Arial;margin:0}
    a{color:#e9ecf1;text-decoration:none}
    nav{background:#0b132b;border-bottom:1px solid rgba(255,255,255,.08)}
    .nav-inner{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;font-weight:800;letter-spacing:.3px}
    .brand img{height:28px;width:auto;margin-right:8px;display:block;object-fit:contain}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:24px}
    @media (max-width:1100px){ .row{grid-template-columns:1fr} }
    .card{background:#121832;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px 16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    input,button{background:#1a2250;border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#fff}
    input{padding:.55rem .7rem}
    button{padding:.55rem .8rem;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .muted{color:#aab4cc}
    .tabs a{opacity:.85;margin-left:18px}
    .tabs a.active{opacity:1;color:#7cb8ff;font-weight:700}
    ul.list{list-style:none;padding:0;margin:0}
    ul.list li{border-bottom:1px solid rgba(255,255,255,.08);padding:10px 0}
    .pill{display:inline-block;background:#1a2250;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:2px 8px;font-size:.8rem;margin-left:8px}
    .scroll{max-height:520px;overflow:auto}
    h4 small{font-weight:400}
    .desc{margin-top:4px}
  </style>
</head>
<body>
  <nav>
    <div class="nav-inner">
      <div class="brand">
        <img src="/static/company_logo.png" alt="Fountain AI logo"><span>Fountain AI - Market Intelligence That Matters</span>
      </div>
      <div class="tabs">
        <a href="/">Home</a>
        <a href="/congress">Congress Trades</a>
        <a href="/portfolio" class="active">My Portfolio</a>
      </div>
    </div>
  </nav>

  <div class="wrap">
    <h1>Personalized Portfolio</h1>
    <p class="muted">Enter tickers (comma-separated). We’ll save them locally, show tailored news, and list recent SEC filings (10-K / 10-Q / 8-K).</p>

    <div class="card" style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap">
      <input id="tickers" placeholder="AAPL, MSFT, NVDA" style="flex:1;min-width:260px">
      <button id="saveBtn">Save</button>
      <button id="refreshBtn">Refresh</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="row">
      <div class="card">
        <h3>News for your portfolio</h3>
        <div class="scroll">
          <ul class="list" id="newsList"></ul>
        </div>
      </div>

      <div class="card">
        <h3>Recent SEC Filings <small class="muted">(10-K / 10-Q / 8-K)</small></h3>
        <div class="scroll" id="secContainer">
          <div class="muted">Add tickers above to see filings.</div>
        </div>
        <div class="muted" style="margin-top:8px">Source: SEC EDGAR</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <label class="muted">Quick view:</label>
      <div id="tickerButtons" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>
  </div>

<script>
  const lsKey = 'fountain_portfolio';

  function parseTickersFromInput() {
    const val = (document.getElementById('tickers').value || '').trim();
    return val ? val.split(',').map(s => s.trim().toUpperCase()).filter(Boolean) : [];
  }

  function getTickers() {
    const fromInput = parseTickersFromInput();
    if (fromInput.length) return fromInput;
    const v = localStorage.getItem(lsKey) || '';
    return v.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
  }

  function setTickers(arr){ localStorage.setItem(lsKey, arr.join(', ')); }

  function renderTickerButtons(ticks){
    const box = document.getElementById('tickerButtons');
    box.innerHTML = '';
    ticks.forEach(t=>{
      const b = document.createElement('button'); b.textContent = t;
      b.onclick = () => window.open(`https://finance.yahoo.com/quote/${t}`, '_blank');
      box.appendChild(b);
    });
  }

  async function loadNews(){
    const ticks = getTickers();
    const list = document.getElementById('newsList');
    list.innerHTML = '';
    if(!ticks.length){ list.innerHTML = '<li class="muted">Add tickers above to see news.</li>'; return; }
    const q = encodeURIComponent(ticks.join(','));
    try{
      const res = await fetch(`/api/news?tickers=${q}`);
      const data = await res.json();
      (data.articles||[]).slice(0,40).forEach(a=>{
        const li = document.createElement('li');
        const when = a.published_at ? new Date(a.published_at).toLocaleString() : '';
        li.innerHTML = `<a href="${a.url}" target="_blank">${a.title}</a><div class="muted">${a.source}${when?' • '+when:''}</div>`;
        list.appendChild(li);
      });
      if(!list.children.length){ list.innerHTML = '<li class="muted">No recent headlines.</li>'; }
    }catch(e){
      console.error('loadNews error', e);
      list.innerHTML = '<li class="muted">Failed to load news.</li>';
    }
  }

  function truncate(s, n){
    if(!s) return '';
    return s.length > n ? s.slice(0, n-1) + '…' : s;
  }

  async function loadSec(){
    const ticks = getTickers();
    const box = document.getElementById('secContainer');
    box.innerHTML = '';
    if(!ticks.length){ box.innerHTML = '<div class="muted">Add tickers above to see filings.</div>'; return; }
    try{
      const q = encodeURIComponent(ticks.join(','));
      const url = `/api/sec/filings-browse-for?tickers=${q}&forms=10-K,10-Q,8-K&count_per=200`;
      console.log('[SEC] GET', url);
      const res = await fetch(url, { cache: 'no-store' });
      const data = await res.json();

      const byTicker = data.by_ticker || {};
      const keys = Object.keys(byTicker).sort();
      if(!keys.length){
        box.innerHTML = '<div class="muted">No filings returned (rate limit or network issue?).</div>';
        console.warn('filings empty', data);
        return;
      }

      keys.forEach(t=>{
        const list = byTicker[t] || [];
        const section = document.createElement('div');
        section.style.marginBottom = '12px';
        section.innerHTML = `<h4>${t}<span class="pill">${list.length}</span></h4>`;
        const ul = document.createElement('ul'); ul.className = 'list';

        if(!list.length){
          const li = document.createElement('li'); li.className='muted'; li.textContent='No recent filings.'; ul.appendChild(li);
        }else{
          list.forEach(f=>{
            const when = f.filed_at ? new Date(f.filed_at).toLocaleString() : '';
            const desc = f.desc ? `<div class="muted desc">${truncate(f.desc, 180)}</div>` : '';
            const li = document.createElement('li');
            li.innerHTML = `
              <a href="${f.url}" target="_blank">${f.form} — ${f.company}</a>
              <div class="muted">${when}</div>
              ${desc}
            `;
            ul.appendChild(li);
          });
        }
        section.appendChild(ul);
        box.appendChild(section);
      });
    }catch(e){
      console.error('loadSec error', e);
      box.innerHTML = '<div class="muted">Failed to load SEC filings.</div>';
    }
  }

  document.getElementById('saveBtn').onclick = ()=>{
    const arr = parseTickersFromInput();
    setTickers(arr); renderTickerButtons(arr); loadNews(); loadSec();
    document.getElementById('status').textContent = 'Saved.';
    setTimeout(()=>document.getElementById('status').textContent='', 1500);
  };

  document.getElementById('refreshBtn').onclick = ()=>{
    const arr = parseTickersFromInput();
    if (arr.length) { setTickers(arr); renderTickerButtons(arr); }
    loadNews(); loadSec();
  };

  document.getElementById('tickers').addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('saveBtn').click(); }
  });

  const saved = (localStorage.getItem(lsKey)||'').split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
  document.getElementById('tickers').value = saved.join(', ');
  renderTickerButtons(saved);
  if(saved.length){ loadNews(); loadSec(); }
</script>

</body>
</html>
