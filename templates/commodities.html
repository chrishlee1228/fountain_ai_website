<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fountain AI ‚Äî Commodities</title>
  <link rel="icon" type="image/png" href="/static/company_logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1020;
      --panel:#121832;
      --text:#e9ecf1;
      --muted:#aab4cc;
      --brand:#7cb8ff;
      --accent:#ff6b9d;
      --green:#4ade80;
      --red:#f87171;
      --border:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.5 system-ui,Segoe UI,Roboto,Arial;
    }
    a{color:var(--text);text-decoration:none}
    nav{
      background:#0b132b;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:100;
    }
    .nav-inner{
      max-width:1400px;
      margin:0 auto;
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{display:flex;align-items:center;font-weight:800;letter-spacing:.3px}
    .brand img{height:28px;margin-right:8px}
    .tabs a{opacity:.85;margin-left:18px;transition:all 0.2s}
    .tabs a:hover{opacity:1}
    .tabs a.active{opacity:1;color:var(--brand);font-weight:700}
    
    .wrap{max-width:1400px;margin:0 auto;padding:24px}
    h1{margin:10px 0 16px;font-size:32px}
    h2{margin:24px 0 16px;font-size:24px;border-bottom:2px solid var(--border);padding-bottom:8px}
    h3{margin:16px 0 12px;font-size:18px}
    
    .category-section{margin-bottom:40px}
    .chart-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(500px, 1fr));gap:20px;margin-top:16px}
    
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 24px rgba(0,0,0,.25);
    }
    
    .chart-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .chart-header h4{margin:0;font-size:15px;font-weight:600}
    .chart-meta{display:flex;gap:12px;align-items:center;font-size:12px}
    .chart-last-updated{color:var(--muted);font-style:italic}
    .chart-change{
      padding:4px 8px;
      border-radius:6px;
      font-weight:600;
      font-size:11px;
    }
    .chart-change.up{background:rgba(74,222,128,0.1);color:var(--green)}
    .chart-change.down{background:rgba(248,113,113,0.1);color:var(--red)}
    
    .chart-wrapper{position:relative;height:280px}
    .chart-wrapper canvas{display:block;width:100%;height:100%}
    
    .impact-section{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--border);
    }
    .impact-title{
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .stock-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
    .stock-tag{
      background:rgba(124,184,255,0.1);
      color:var(--brand);
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      border:1px solid rgba(124,184,255,0.2);
    }
    .stock-tag.benefit{background:rgba(74,222,128,0.1);color:var(--green);border-color:rgba(74,222,128,0.2)}
    .stock-tag.hurt{background:rgba(248,113,113,0.1);color:var(--red);border-color:rgba(248,113,113,0.2)}
    
    .muted{color:var(--muted);font-size:13px}
    .note{
      font-size:12px;
      color:var(--muted);
      font-style:italic;
      margin-top:8px;
      padding:8px;
      background:rgba(255,255,255,0.02);
      border-radius:6px;
    }
    
    .loading{text-align:center;padding:40px;color:var(--muted)}
    .error{color:var(--red);padding:12px;background:rgba(248,113,113,0.1);border-radius:8px;margin:12px 0}
    
    .summary-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:16px;
      margin-bottom:32px;
    }
    .summary-card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      text-align:center;
    }
    .summary-value{font-size:28px;font-weight:700;margin:8px 0}
    .summary-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .summary-change{font-size:14px;margin-top:4px}
  </style>
</head>

<body>
  <nav>
    <div class="nav-inner">
      <div class="brand">
        <img src="/static/company_logo.png" alt="Fountain AI logo">
        <span>Fountain AI - Market Intelligence That Matters</span>
      </div>
      <div class="tabs">
        <a href="/">Home</a>
        <a href="/commodities" class="active">Commodities</a>
        <a href="/congress">Congress</a>
        <a href="/portfolio">My Portfolio</a>
      </div>
    </div>
  </nav>

  <div class="wrap">
    <h1>üì¶ Commodity Price Tracking & Stock Impact Analysis</h1>
    <p class="muted">Track input costs across industries and understand their impact on publicly traded companies</p>
    
    <div class="summary-grid" id="summaryGrid">
      <div class="loading">Loading summary...</div>
    </div>
    
    <div id="categoriesContainer">
      <div class="loading">Loading commodity data...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
    // Commodity metadata from backend
    let COMMODITY_META = {};
    let IMPACT_DATA = {};
    
    async function loadMetadata() {
      try {
        const [metaRes, impactRes] = await Promise.all([
          fetch('/api/commodities/metadata'),
          fetch('/api/commodities/impacts')
        ]);
        COMMODITY_META = await metaRes.json();
        IMPACT_DATA = await impactRes.json();
      } catch (err) {
        console.error('Failed to load metadata:', err);
      }
    }
    
    function formatNumber(num) {
      if (num === null || num === undefined) return 'N/A';
      if (Math.abs(num) >= 1000) {
        return num.toLocaleString('en-US', {maximumFractionDigits: 0});
      }
      return num.toLocaleString('en-US', {maximumFractionDigits: 2});
    }
    
    function formatChange(current, previous) {
      if (!current || !previous) return '';
      const pct = ((current - previous) / previous * 100);
      const sign = pct >= 0 ? '+' : '';
      const className = pct >= 0 ? 'up' : 'down';
      return `<span class="chart-change ${className}">${sign}${pct.toFixed(1)}%</span>`;
    }
    
    function findLastChangeDate(labels, values) {
      if (values.length < 2) return labels[labels.length - 1];
      
      const lastValue = values[values.length - 1];
      for (let i = values.length - 2; i >= 0; i--) {
        if (values[i] !== lastValue) {
          return labels[i + 1];
        }
        if (i === 0) return labels[0];
      }
      return labels[labels.length - 1];
    }
    
    async function loadCommodityData() {
      await loadMetadata();
      
      // Get list of all commodities
      const commodities = Object.keys(COMMODITY_META);
      if (commodities.length === 0) {
        document.getElementById('categoriesContainer').innerHTML = 
          '<div class="error">No commodity data available</div>';
        return;
      }
      
      // Fetch data for all commodities
      const dataPromises = commodities.map(id => 
        fetch(`/api/commodities/${id}?months=24`)
          .then(r => r.json())
          .catch(err => ({ error: err.message, id }))
      );
      
      const allData = await Promise.all(dataPromises);
      
      // Group by category
      const categories = {};
      commodities.forEach((id, idx) => {
        const meta = COMMODITY_META[id];
        const data = allData[idx];
        
        if (!meta || data.error) return;
        
        const cat = meta.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push({ id, meta, data });
      });
      
      // Render categories
      const container = document.getElementById('categoriesContainer');
      container.innerHTML = '';
      
      Object.entries(categories).sort().forEach(([category, items]) => {
        const section = document.createElement('div');
        section.className = 'category-section';
        section.innerHTML = `<h2>${category}</h2>`;
        
        const grid = document.createElement('div');
        grid.className = 'chart-grid';
        
        items.forEach(({ id, meta, data }) => {
          grid.appendChild(createCommodityCard(id, meta, data));
        });
        
        section.appendChild(grid);
        container.appendChild(section);
      });
      
      // Update summary
      updateSummary(allData, commodities);
    }
    
    function createCommodityCard(id, meta, data) {
      const card = document.createElement('div');
      card.className = 'card';
      
      const labels = data.map(d => d.date);
      const values = data.map(d => d[id]);
      
      const lastValue = values[values.length - 1];
      const prevValue = values[values.length - 30] || values[0]; // ~30 days ago
      const changeHtml = formatChange(lastValue, prevValue);
      
      const lastChangeDate = findLastChangeDate(labels, values);
      const formattedDate = new Date(lastChangeDate).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'short', day: 'numeric' 
      });
      
      card.innerHTML = `
        <div class="chart-header">
          <h4>${meta.label}</h4>
          <div class="chart-meta">
            ${changeHtml}
            <div class="chart-last-updated">As of ${formattedDate}</div>
          </div>
        </div>
        <div class="chart-wrapper">
          <canvas id="chart-${id}"></canvas>
        </div>
        <div id="impact-${id}"></div>
      `;
      
      // Create chart
      setTimeout(() => {
        const ctx = document.getElementById(`chart-${id}`).getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: meta.label,
              data: values,
              borderColor: '#7cb8ff',
              backgroundColor: 'rgba(124,184,255,0.1)',
              borderWidth: 2,
              pointRadius: 0,
              pointHoverRadius: 4,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            maintainAspectRatio: false,
            responsive: true,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            scales: {
              x: {
                ticks: { color: '#aab4cc', maxTicksLimit: 6 },
                grid: { color: 'rgba(255,255,255,0.05)' }
              },
              y: {
                ticks: { 
                  color: '#aab4cc',
                  callback: (value) => formatNumber(value)
                },
                grid: { color: 'rgba(255,255,255,0.05)' }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1a2250',
                titleColor: '#e9ecf1',
                bodyColor: '#e9ecf1',
                borderColor: 'rgba(255,255,255,0.1)',
                borderWidth: 1,
                padding: 12,
                displayColors: false,
                callbacks: {
                  label: (context) => `${formatNumber(context.parsed.y)} ${meta.unit}`
                }
              }
            }
          }
        });
      }, 0);
      
      // Add impact section
      setTimeout(() => {
        const impactDiv = document.getElementById(`impact-${id}`);
        const impacts = findImpacts(id);
        if (impacts) {
          impactDiv.innerHTML = renderImpacts(impacts);
        }
      }, 0);
      
      return card;
    }
    
    function findImpacts(commodityId) {
      // Find industries that use this commodity
      for (const [industry, data] of Object.entries(IMPACT_DATA)) {
        if (data.commodities && data.commodities.includes(commodityId)) {
          return data;
        }
      }
      return null;
    }
    
    function renderImpacts(impacts) {
      let html = '<div class="impact-section">';
      
      if (impacts.price_up_benefits && Object.keys(impacts.price_up_benefits).length > 0) {
        html += '<div class="impact-title">‚úÖ Benefits from higher prices</div>';
        html += '<div class="stock-list">';
        for (const [ticker, name] of Object.entries(impacts.price_up_benefits)) {
          html += `<span class="stock-tag benefit" title="${name}">${ticker}</span>`;
        }
        html += '</div>';
      }
      
      if (impacts.price_up_hurts && Object.keys(impacts.price_up_hurts).length > 0) {
        html += '<div class="impact-title">‚ö†Ô∏è Hurt by higher prices</div>';
        html += '<div class="stock-list">';
        for (const [ticker, name] of Object.entries(impacts.price_up_hurts)) {
          html += `<span class="stock-tag hurt" title="${name}">${ticker}</span>`;
        }
        html += '</div>';
      }
      
      if (impacts.notes) {
        html += `<div class="note">üí° ${impacts.notes}</div>`;
      }
      
      html += '</div>';
      return html;
    }
    
    function updateSummary(allData, commodities) {
      const grid = document.getElementById('summaryGrid');
      
      // Calculate some interesting stats
      const oilData = allData.find(d => d[0]?.Crude_Oil_WTI);
      const goldData = allData.find(d => d[0]?.Gold);
      const copperData = allData.find(d => d[0]?.Copper);
      
      let html = '';
      
      if (oilData && oilData.length > 0) {
        const oil = oilData[oilData.length - 1].Crude_Oil_WTI;
        const oilPrev = oilData[Math.max(0, oilData.length - 30)]?.Crude_Oil_WTI || oil;
        html += `
          <div class="summary-card">
            <div class="summary-label">Oil (WTI)</div>
            <div class="summary-value">$${formatNumber(oil)}</div>
            <div class="summary-change">${formatChange(oil, oilPrev)}</div>
          </div>
        `;
      }
      
      if (goldData && goldData.length > 0) {
        const gold = goldData[goldData.length - 1].Gold;
        const goldPrev = goldData[Math.max(0, goldData.length - 30)]?.Gold || gold;
        html += `
          <div class="summary-card">
            <div class="summary-label">Gold</div>
            <div class="summary-value">$${formatNumber(gold)}</div>
            <div class="summary-change">${formatChange(gold, goldPrev)}</div>
          </div>
        `;
      }
      
      if (copperData && copperData.length > 0) {
        const copper = copperData[copperData.length - 1].Copper;
        const copperPrev = copperData[Math.max(0, copperData.length - 30)]?.Copper || copper;
        html += `
          <div class="summary-card">
            <div class="summary-label">Copper</div>
            <div class="summary-value">$${formatNumber(copper)}</div>
            <div class="summary-change">${formatChange(copper, copperPrev)}</div>
          </div>
        `;
      }
      
      html += `
        <div class="summary-card">
          <div class="summary-label">Tracking</div>
          <div class="summary-value">${commodities.length}</div>
          <div class="summary-change muted">Commodities</div>
        </div>
      `;
      
      grid.innerHTML = html;
    }
    
    window.addEventListener('DOMContentLoaded', loadCommodityData);
  </script>
</body>
</html>